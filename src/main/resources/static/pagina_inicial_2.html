<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard TXs</title>
    <style>
        body {
          margin: 0;
          font-family: Arial, sans-serif;
          background: #121212;
          color: #fff;
        }

        header {
          background: #1f1f1f;
          padding: 15px 30px;
          font-size: 20px;
          font-weight: bold;
          color: #ff002b;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        main {
          display: flex;
          height: calc(100vh - 60px);
        }

        /* ===== Sidebar cidades ===== */
        #sidebar-container {
          width: 220px;
          border-right: 2px solid #444;
          background: #1f1f1f;
          transition: width 0.3s ease;
          overflow: hidden;
          position: relative;
          display: flex;
          flex-direction: column;
        }

        #lista-cidades {
          list-style: none;
          padding: 0;
          margin: 0;
          flex: 1;
          overflow-y: auto;
        }

        #lista-cidades li {
          padding: 12px;
          cursor: pointer;
          transition: background 0.2s;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        #lista-cidades li:hover {
          background: #2c2c2c;
        }

        #lista-cidades li.active {
          background: #cc0022;
          font-weight: bold;
        }

        #lista-cidades li.hidden {
          display: none; /* Para esconder cidades que n√£o correspondem √† pesquisa */
        }

        #lista-cidades li.no-results {
          display: block !important;
          background: #ff002b;
          text-align: center;
          cursor: default;
          color: #fff;
          font-style: italic;
          padding: 20px;
        }

        /* Bot√£o retr√°til */
        .toggle-btn {
          position: absolute;
          top: 20px;
          right: -15px;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          border: none;
          background: #cc0022;
          color: white;
          cursor: pointer;
          transition: transform 0.3s;
          z-index: 10;
        }

        #sidebar-container.colapsado {
          width: 50px;
        }

        #sidebar-container.colapsado #lista-cidades li {
          text-align: center;
          padding: 15px 0;
        }

        #sidebar-container.colapsado #lista-cidades li span {
          display: none;
        }

        #sidebar-container.colapsado .search-container {
          width: 50px;
          padding: 10px 0;
        }

        #sidebar-container.colapsado #search-input {
          display: none;
        }

        .conteudo {
          flex: 1;
          padding: 20px;
          overflow-y: auto;
        }

        .cidade-info {
          font-size: 18px;
          margin-bottom: 15px;
          color: #ff0831;
        }

        #tx-grid {
          display: flex;
          flex-wrap: wrap;
          gap: 15px;
        }

        .tx-container {
          width: calc(25% - 15px);
          box-sizing: border-box;
        }

        .tx-container h3 {
          margin-bottom: 0;
          color: #ff0831;
          cursor: pointer;
          padding: 10px;
          background: #222;
          border-radius: 8px;
          transition: background 0.2s;
        }

        .tx-container h3:hover {
          background: #444;
        }

        .tx-grid-interna {
          display: none;
          margin-top: 10px;
          gap: 10px;
        }

        .tx-container.active .tx-grid-interna {
          display: grid;
          grid-template-columns: 1fr;
        }

        .tx-card {
          background: #333;
          padding: 15px;
          border-radius: 12px;
          text-align: center;
          font-weight: bold;
          transition: transform 0.2s;
        }

        .tx-card:hover {
          transform: scale(1.05);
        }

        h4 {
          margin: 0 0 5px;
        }

        .panel {
          padding: 20px;
        }

        /* Status colors */
        .tx-off { background-color: #1f1f1f; }
        .tx-erro { background-color: #ff002b; }
        .tx-ok { background-color: #2c2c2c; }
        .tx-warning { background-color: #ffd400; color: black; }

        /* ===== NOVA SE√á√ÉO PARA VARREDURAGERAL (MTX) ===== */
        #varredura-section {
          margin-top: 30px;
          padding: 20px;
          background: #1f1f1f;
          border-radius: 12px;
          border: 1px solid #444;
          display: none; /* Inicialmente oculta */
        }

        #varredura-section h2 {
          color: #ff0831;
          margin-bottom: 20px;
          text-align: center;
        }

        .accordion {
          margin-bottom: 15px;
        }

        .accordion-header {
          background: #333;
          padding: 12px;
          cursor: pointer;
          border-radius: 8px;
          font-weight: bold;
          transition: background 0.2s;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .accordion-header:hover {
          background: #444;
        }

        .accordion-header.active {
          background: #cc0022;
        }

        .accordion-content {
          display: none;
          padding: 15px;
          background: #2c2c2c;
          border-radius: 8px;
          margin-top: 5px;
        }

        .accordion-content.active {
          display: block;
        }

        .status-normal { color: #00ff00; } /* Verde */
        .status-alarm { color: #ffd400; } /* Amarelo */
        .status-error { color: #ff002b; } /* Vermelho */
        .status-disabled { color: #888; } /* Cinza */
        .status-unknown { color: #888; } /* Cinza */

        .sub-card {
          background: #333;
          padding: 10px;
          margin: 10px 0;
          border-radius: 6px;
          border-left: 4px solid #ff0831;
        }

        .sub-card h5 {
          margin: 0 0 8px;
          color: #ff0831;
        }

        ul {
          list-style-type: none;
          padding: 0;
        }

        li {
          padding: 5px 0;
          border-bottom: 1px solid #444;
        }

        li:last-child {
            border-bottom: none;
        }

        .loading {
          text-align: center;
          color: #ffffff;
          font-style: italic;
        }

        /* ===== ESTILOS PARA A BARRA DE PESQUISA ===== */
        .search-container {
          padding: 10px;
          background: #1f1f1f;
          border-bottom: 1px solid #444;
          position: relative;
        }

        #search-input {
          width: 100%;
          padding: 10px 12px 10px 35px; /* Espa√ßo para √≠cone de lupa */
          background: #2c2c2c;
          border: 1px solid #444;
          border-radius: 6px;
          color: #fff;
          font-size: 14px;
          box-sizing: border-box;
          outline: none;
          transition: border-color 0.2s;
        }

        #search-input:focus {
          border-color: #cc0022;
        }

        #search-input::placeholder {
          color: #888;
        }

        .search-icon {
          position: absolute;
          left: 25px;
          top: 50%;
          transform: translateY(-50%);
          color: #888;
          font-size: 16px;
          pointer-events: none;
        }

        .no-results-message {
          display: none;
          text-align: center;
          padding: 20px;
          color: #ff002b;
          font-style: italic;
        }
    </style>
</head>
<body>

<header>
    <link href="icon.png" rel="icon" type="image/png">
    <span class="status-time" id="dateTime">--:--:--</span>
</header>

<main>
    <!-- NOVA BARRA DE PESQUISA NA SIDEBAR -->
    <div id="sidebar-container">
        <div class="search-container">
            <span class="search-icon">üîç</span> <!-- √çcone de lupa simples -->
            <input type="search" id="search-input" placeholder="Pesquisar cidade (ex: Cafeara, PR, Rio...)" />
            <div id="no-results-message" class="no-results-message">Nenhuma cidade encontrada. Tente outra busca.</div>
        </div>
        <ul id="lista-cidades">
            <!-- SUA LISTA DE CIDADES ORIGINAL VAI AQUI. EX: -->
            <li data-id="885"><span>PR - Capanema</span></li>
            <li data-id="1312"><span>PR - Cafeara</span></li>
            <li data-id="1432"><span>PR - Siqueira Campos</span></li>
            <li data-id="529"><span>SC - Rio Fortuna</span></li>
            <li data-id="397"><span>BA - Igrapiuna</span></li>
            <li data-id="994"><span>BA - Igapora</span></li>
            <li data-id="389"><span>BA - Ibitiara</span></li>
            <li data-id="1452"><span>BA - Ibirapitanga</span></li>
            <li data-id="1329"><span>PR - Cambara</span></li>
            <li data-id="410"><span>PR - Campina da Lagoa</span></li>
            <li data-id="1464"><span>BA - Gloria</span></li>
            <li data-id="411"><span>PR - Campo Bonito</span></li>
            <li data-id="298"><span>AL - Agua Branca</span></li>
            <li data-id="288"><span>PE - Orobo</span></li>
            <li data-id="1339"><span>PR - Boa Ventura de Sao Roque</span></li>
            <li data-id="1403"><span>PR - Tibagi</span></li>
            <li data-id="500"><span>SC - Angelina</span></li>
            <li data-id="2802"><span>AL - Campo Alegre</span></li>
            <li data-id="1328"><span>PR - Ariranha do Ivai</span></li>
            <li data-id="1338"><span>PR - Arapoti</span></li>
            <li data-id="263"><span>AL - Canapi</span></li>
            <li data-id="532"><span>SC - Salete</span></li>
            <li data-id="419"><span>PR - Cidade Gaucha</span></li>
            <li data-id="1131"><span>BA - Jussari</span></li>
            <li data-id="1289"><span>SC - Sao Martinho</span></li>
            <li data-id="1278"><span>AL - Joaquim Gomes</span></li>
            <li data-id="280"><span>AL - Maravilha</span></li>
            <li data-id="1404"><span>PR - Tres Barras do Parana</span></li>
            <li data-id="467"><span>RS - Casca</span></li>
            <li data-id="1405"><span>PR - Ubirata</span></li>
            <li data-id="387"><span>BA - Elisio Medrado</span></li>
            <li data-id="1134"><span>RJ - Bom Jardim</span></li>
            <li data-id="406"><span>PR - Andira</span></li>
            <li data-id="405"><span>PR - Ampere</span></li>
            <li data-id="1984"><span>RJ - Bom Jesus do Itabapoana</span></li>
            <li data-id="1982"><span>RJ - Casimiro de Abreu</span></li>
            <li data-id="503"><span>SC - Apiuna</span></li>
            <li data-id="1284"><span>SC - Vargem Bonita</span></li>
            <li data-id="1299"><span>PR - Doutor Ulysses</span></li>
            <li data-id="1350"><span>PR - Figueira</span></li>
            <li data-id="376"><span>BA - Curaca</span></li>
            <li data-id="1336"><span>PR - Formosa do Oeste</span></li>
            <li data-id="508"><span>SC - Capinzal</span></li>
            <li data-id="1361"><span>SC - Caxambu do Sul</span></li>
            <li data-id="919"><span>SC - Coronel Freitas</span></li>
            <li data-id="1382"><span>PR - Guapirama</span></li>
            <li data-id="1383"><span>PR - Guaraniacu</span></li>
            <li data-id="413"><span>SC - Vidal Ramos</span></li>
            <li data-id="407"><span>SC - Vitor Meireles</span></li>
            <li data-id="287"><span>AL - Sao Bras</span></li>
            <li data-id="2806"><span>RJ - Natividade</span></li>
            <li data-id="1502"><span>AL - Sao Jose da Laje</span></li>
            <li data-id="1410"><span>RS - Cacique Doble</span></li>
            <li data-id="1273"><span>AL - Sao Jose da Tapera</span></li>
            <li data-id="275"><span>PE - Jurema</span></li>
            <li data-id="1521"><span>PE - Parnamirim</span></li>
            <li data-id="291"><span>PE - Passira</span></li>
            <li data-id="476"><span>RS - Ibiaca</span></li>
            <li data-id="352"><span>BA - Castro Alves</span></li>
            <li data-id="477"><span>RS - Ibiraiaras</span></li>
            <li data-id="509"><span>SC - Descanso</span></li>
            <li data-id="1371"><span>SC - Dona Emma</span></li>
            <li data-id="358"><span>BA - Capela do Alto Alegre</span></li>
            <li data-id="478"><span>RS - Independencia</span></li>
            <li data-id="209"><span>PE - Aguas Belas</span></li>
            <li data-id="481"><span>RS - Manoel Viana</span></li>
            <li data-id="1493"><span>SE - Capela</span></li>
            <li data-id="1455"><span>PE - Pombos</span></li>
            <li data-id="353"><span>BA - Maetinga</span></li>
            <li data-id="510"><span>SC - Erval Velho</span></li>
            <li data-id="377"><span>BA - Wagner</span></li>
            <li data-id="1501"><span>PE - Altinho</span></li>
            <li data-id="1180"><span>PE - Amaraji</span></li>
            <li data-id="692"><span>RS - Porto Lucena</span></li>
            <li data-id="2804"><span>PE - Barra de Guabiraba</span></li>
            <li data-id="3652"><span>RS - Progresso</span></li>
            <li data-id="1293"><span>PE - Barreiros</span></li>
            <li data-id="3092"><span>BA - Varzedo</span></li>
            <li data-id="1420"><span>RS - Putinga</span></li>
            <li data-id="5026"><span>RS - Roca Sales</span></li>
            <li data-id="1351"><span>PR - Imbau</span></li>
            <li data-id="1316"><span>AL - Sao Sebastiao</span></li>
            <li data-id="N/A"><span>AL - Tanque d Arca</span></li>
            <li data-id="273"><span>PE - Jupi</span></li>
            <li data-id="1319"><span>AL - Teotonio Vilela</span></li>
            <li data-id="491"><span>RS - Santa Barbara do Sul</span></li>
            <li data-id="2858"><span>PE - Jucati</span></li>
            <li data-id="1440"><span>PE - Belem do Sao Francisco</span></li>
            <li data-id="223"><span>PE - Brejao</span></li>
            <li data-id="3692"><span>RS - Sao Jose do Herval</span></li>
            <li data-id="10610"><span>RS - Tapera</span></li>
            <li data-id="1146"><span>PR - Iretama</span></li>
            <li data-id="366"><span>BA - Ubaira</span></li>
            <li data-id="1424"><span>RS - Tupancireta</span></li>
            <li data-id="425"><span>PR - Ivai</span></li>
            <li data-id="270"><span>PE - Joao Alfredo</span></li>
            <li data-id="1385"><span>PR - Joaquim Tavora</span></li>
            <li data-id="1357"><span>SC - Ipira</span></li>
            <li data-id="1327"><span>SC - Ipora do Oeste</span></li>
            <li data-id="1143"><span>PE - Jatoba</span></li>
            <li data-id="359"><span>BA - Agua Fria</span></li>
            <li data-id="1425"><span>RS - Vila Flores</span></li>
            <li data-id="1165"><span>PE - Cachoeirinha</span></li>
            <li data-id="1427"><span>SC - Agrolandia</span></li>
            <li data-id="1977"><span>PE - Calcado</span></li>
            <li data-id="1477"><span>PE - Sanharo</span></li>
            <li data-id="N/A"><span>PE - Santa Maria do Cambuca</span></li>
            <li data-id="1480"><span>PE - Santa Terezinha</span></li>
            <li data-id="239"><span>PE - Capoeiras</span></li>
            <li data-id="1978"><span>SC - Jaguaruna</span></li>
            <li data-id="245"><span>SE - Neopolis</span></li>
            <li data-id="1446"><span>PE - Condado</span></li>
            <li data-id="1363"><span>PE - Cortes</span></li>
            <li data-id="1389"><span>PR - Paraiso do Norte</span></li>
            <li data-id="2556"><span>PR - Pien</span></li>
            <li data-id="333"><span>BA - Muquem de Sao Francisco</span></li>
            <li data-id="1250"><span>BA - Nilo Pecanha</span></li>
            <li data-id="357"><span>BA - Aracas</span></li>
            <li data-id="2864"><span>PE - Xexeu</span></li>
            <li data-id="326"><span>BA - Nova Redencao</span></li>
            <li data-id="1522"><span>PE - Itacuruba</span></li>
            <li data-id="371"><span>BA - Arataca</span></li>
            <li data-id="254"><span>PE - Cumaru</span></li>
            <li data-id="438"><span>PR - Pinhao</span></li>
            <li data-id="523"><span>SC - Nova Erechim</span></li>
            <li data-id="439"><span>PR - Planalto</span></li>
            <li data-id="1433"><span>PE - Sao Joaquim do Monte</span></li>
            <li data-id="1133"><span>SC - Papanduva</span></li>
            <li data-id="246"><span>SE - Riachao do Dantas</span></li>
            <li data-id="363"><span>BA - Barrocas</span></li>
            <li data-id="402"><span>SC - Peritiba</span></li>
            <li data-id="527"><span>SC - Pinheiro Preto</span></li>
            <li data-id="1271"><span>BA - Pojuca</span></li>
            <li data-id="1317"><span>SC - Piratuba</span></li>
            <li data-id="391"><span>BA - Ponto Novo</span></li>
            <li data-id="393"><span>BA - Presidente Tancredo Neves</span></li>
            <li data-id="443"><span>PR - Querencia do Norte</span></li>
            <li data-id="256"><span>PE - Custodia</span></li>
            <li data-id="1511"><span>PE - Exu</span></li>
            <li data-id="1305"><span>SC - Rio do Campo</span></li>
            <li data-id="549"><span>ES - Pinheiros</span></li>
            <li data-id="2262"><span>SC - Rio do Oeste</span></li>
            <li data-id="336"><span>BA - Belmonte</span></li>
            <li data-id="2297"><span>BA - Sao Jose da Vitoria</span></li>
            <li data-id="1478"><span>PE - Gameleira</span></li>
            <li data-id="8099"><span>PE - Gravata</span></li>
            <li data-id="448"><span>PR - Rio Bonito do Iguacu</span></li>
            <li data-id="1517"><span>PE - Ibimirim</span></li>
            <li data-id="307"><span>PE - Sao Jose do Belmonte</span></li>
            <li data-id="451"><span>PR - Salto do Lontra</span></li>
            <li data-id="1529"><span>PE - Sao Jose do Egito</span></li>
            <li data-id="1398"><span>PR - Santo Inacio</span></li>
            <li data-id="1399"><span>PR - Sao Joao do Caiua</span></li>
            <li data-id="1491"><span>PE - Terezinha</span></li>
            <li data-id="1492"><span>PE - Toritama</span></li>
            <li data-id="1495"><span>PE - Trindade</span></li>
            <li data-id="1136"><span>ES - Dores do Rio Preto</span></li>
            <li data-id="1498"><span>PE - Tuparetama</span></li>
            <li data-id="2742"><span>ES - Ecoporanga</span></li>
            <li data-id="1207"><span>ES - Ibiracu</span></li>
            <li data-id="310"><span>BA - Serra Dourada</span></li>
            <li data-id="368"><span>BA - Jitauna</span></li>
            <li data-id="400"><span>BA - Itapitanga</span></li>
            <li data-id="384"><span>BA - Itaju do Colonia</span></li>
            <li data-id="1428"><span>SC - Anchieta</span></li>
            <li data-id="1310"><span>AL - Cajueiro</span></li>
            <li data-id="1505"><span>AL - Igaci</span></li>
            <li data-id="300"><span>AL - Igreja Nova</span></li>
            <li data-id="266"><span>AL - Jequia da Praia</span></li>
            <li data-id="456"><span>PR - Wenceslau Braz</span></li>
            <li data-id="1902"><span>SC - Benedito Novo</span></li>
            <li data-id="1451"><span>BA - Crisopolis</span></li>
            <li data-id="539"><span>RS - Cambara do Sul</span></li>
            <li data-id="1449"><span>BA - Coaraci</span></li>
            <li data-id="1471"><span>BA - Cipo</span></li>
            <li data-id="2809"><span>PE - Panelas</span></li>
            <li data-id="322"><span>BA - Chorrocho</span></li>
            <li data-id="1219"><span>SE - Boquim</span></li>
            <li data-id="243"><span>SE - Brejo Grande</span></li>
            <li data-id="1457"><span>BA - Lapao</span></li>
            <li data-id="1075"><span>PE - Pocao</span></li>
            <li data-id="1459"><span>PE - Primavera</span></li>
            <li data-id="1466"><span>PE - Quipapa</span></li>
            <li data-id="341"><span>BA - Malhada de Pedras</span></li>
            <li data-id="274"><span>AL - Sao Miguel dos Milagres</span></li>
            <li data-id="221"><span>PE - Betania</span></li>
            <li data-id="1441"><span>PE - Bonito</span></li>
            <li data-id="10796"><span>RS - Sao Vicente do Sul</span></li>
            <li data-id="1258"><span>SE - Japoata</span></li>
            <li data-id="1355"><span>PR - Laranjal</span></li>
            <li data-id="1445"><span>PE - Cabrobo</span></li>
            <li data-id="5318"><span>PE - Carnaiba</span></li>
            <li data-id="250"><span>PE - Carnaubeira da Penha</span></li>
            <li data-id="1388"><span>PR - Nova Cantu</span></li>
            <li data-id="437"><span>PR - Pinhalao</span></li>
            <li data-id="342"><span>BA - Mulungu do Morro</span></li>
            <li data-id="343"><span>BA - Antonio Goncalves</span></li>
            <li data-id="542"><span>PE - Itaiba</span></li>
            <li data-id="440"><span>PR - Pranchita</span></li>
            <li data-id="1474"><span>PE - Vertentes</span></li>
            <li data-id="1248"><span>SE - Ribeiropolis</span></li>
            <li data-id="1203"><span>ES - Anchieta</span></li>
            <li data-id="547"><span>ES - Apiaca</span></li>
            <li data-id="1107"><span>ES - Atilio Vivacqua</span></li>
            <li data-id="1252"><span>SE - Umbauba</span></li>
            <li data-id="329"><span>BA - Cachoeira</span></li>
            <li data-id="551"><span>ES - Piuma</span></li>
            <li data-id="1453"><span>BA - Sao Felix do Coribe</span></li>
            <li data-id="1518"><span>PE - Ibirajuba</span></li>
            <li data-id="32"><span>PE - Sertania</span></li>
            <li data-id="383"><span>BA - Tanquinho</span></li>
            <li data-id="315"><span>PE - Tacaimbo</span></li>
            <li data-id="1298"><span>PE - Triunfo</span></li>
            <li data-id="1188"><span>ES - Conceicao do Castelo</span></li>
        </ul>
    </div>

    <div class="conteudo">
        <div class="cidade-info" id="cidade-info">Escolha uma cidade...</div>
        <div class="panel">
            <div class="tx-grid" id="tx-grid"></div>
        </div>

        <!-- NOVA SE√á√ÉO PARA DADOS DA VARREDURAGERAL (MTX) -->
        <div id="varredura-section">
            <h2>Informa√ß√µes do Transmissor (MTX)</h2>
            <div id="varredura-content" class="loading">Carregando dados do MTX...</div>
        </div>
    </div>
</main>

<script>
    // Fun√ß√£o para renderizar dados do Nemesys (j√° existente, mantida igual)
    function renderTXs(data) {
      const cidadeInfo = document.getElementById('cidade-info');
      const grid = document.getElementById('tx-grid');
      cidadeInfo.innerText = data.cidade || "Cidade n√£o encontrada";
      grid.innerHTML = '';

      if (!data.MTXs) {
          grid.innerHTML = '<p style="grid-column: span 4; text-align: center; color: #ff002b;">Nenhum dado dispon√≠vel</p>';
          return;
      }

      const ordemMTXs = ["MTX1","MTX2","MTX3","MTX4","MTX5","MTX6","MTX7","MTX8"];
      const ordemMetricas = [
          "Pot√™ncia Direta","Pot. Refletida","MER","Conex√£o LAN",
          "Resumo de Falhas","Input Lock","Input C/N",
          "RX Sat 1 Lock","RX Sat 2 Lock","RX Sat 1 C/N","RX Sat 2 C/N"
      ];

      ordemMTXs.forEach(txName => {
          const metrics = data.MTXs[txName];
          if (!metrics) return;

          const txContainer = document.createElement('div');
          txContainer.classList.add('tx-container');

          const txTitle = document.createElement('h3');
          txTitle.innerText = txName;
          txContainer.appendChild(txTitle);

          const metricGrid = document.createElement('div');
          metricGrid.classList.add('tx-grid-interna');
          txContainer.appendChild(metricGrid);

          txTitle.addEventListener('click', () => {
              txContainer.classList.toggle('active');
          });

          ordemMetricas.forEach(nomeBonito => {
              const chaveReal = Object.keys(metrics).find(k => k.startsWith(nomeBonito));
              if (!chaveReal) return;

              const valor = metrics[chaveReal];
              const metricDiv = document.createElement('div');
              metricDiv.classList.add('tx-card');

              let statusClass = "tx-ok";
              if (valor.includes("Erro (503)") || valor.includes("ALARME")) statusClass = "tx-erro";
              if (nomeBonito === "Pot√™ncia Direta" && valor === "0.00 W") statusClass = "tx-erro";
              if (nomeBonito === "Pot. Refletida" && valor === "0.00 W") {
                  const potDiretaKey = Object.keys(metrics).find(k => k.startsWith("Pot√™ncia Direta"));
                  if (metrics[potDiretaKey] !== "0.00 W") statusClass = "tx-erro";
              }
              if (valor.includes("- n√£o dispon√≠vel -")) statusClass = "tx-warning";
              else if (valor.includes("N/A")) statusClass = "tx-off";

              metricDiv.classList.add(statusClass);
              metricDiv.innerHTML = `<h4>${nomeBonito}</h4><p>${valor}</p>`;
              metricGrid.appendChild(metricDiv);
          });

          grid.appendChild(txContainer);
      });
    }

    // Fun√ß√£o auxiliar para determinar a classe de status
    function getStatusClass(status) {
        if (!status) return 'status-unknown';
        status = status.toLowerCase();
        if (status.includes('erro') || status.includes('fault')) return 'status-error';
        if (status.includes('alarme') || status.includes('warning')) return 'status-alarm';
        if (status.includes('normal') || status.includes('enable') || status.includes('ok') || status.includes('running')) return 'status-normal';
        if (status.includes('desabilitado') || status.includes('disabled') || status.includes('off')) return 'status-disabled';
        return 'status-unknown';
    }

    // NOVA FUN√á√ÉO: Renderiza os dados da varreduraGeral (MTX)
    function renderVarredura(data) {
        const section = document.getElementById('varredura-section');
        const content = document.getElementById('varredura-content');

        // Limpa o conte√∫do anterior e mostra a se√ß√£o
        content.innerHTML = '';
        section.style.display = 'block';

        if (data.status !== "Consulta executada com sucesso") {
            content.innerHTML = `<p style="color: #ff002b; text-align: center;">Erro na coleta de dados MTX: ${data.erro || 'Desconhecido'}</p>`;
            return;
        }

        let html = '';

        // Resumo Geral
        html += `
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>Resumo Geral</span>
                    <span>‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="sub-card">
                        <h5>Total de TXs Habilitadas:</h5>
                        <p class="${getStatusClass(data.TotalTXsEnabled > 0 ? 'normal' : 'disabled')}">${data.TotalTXsEnabled || 0} de 8</p>
                    </div>
                    <div class="sub-card">
                        <h5>Serial Number do Equipamento:</h5>
                        <p>${data.SerialNumber || 'N/A'}</p>
                    </div>
                    <div class="sub-card">
                        <h5>Transmitters (IDs Seriais):</h5>
                        <ul>
                            ${data.Transmitters ? data.Transmitters.map(tx => `<li>${tx.TX}: ${tx.Serial || 'N/A'}</li>`).join('') : '<li>N/A</li>'}
                        </ul>
                    </div>
                </div>
            </div>
        `;

        // Status das Boards
        html += `
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>Status das Boards (TXs)</span>
                    <span>‚ñº</span>
                </div>
                <div class="accordion-content">
                    <ul>
                        ${data.BoardsStatus ? data.BoardsStatus.map(board =>
                            `<li class="${getStatusClass(board.Status)}">
                                ${board.TX}: ${board.Status || 'Unknown'}
                            </li>`
                        ).join('') : '<li>Nenhum dado</li>'}
                    </ul>
                </div>
            </div>
        `;

        // ALC Status por TX
        html += `
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ALC Status por TX</span>
                    <span>‚ñº</span>
                </div>
                <div class="accordion-content">
                    <ul>
                        ${Object.entries(data.alcStatusPorTx || {}).map(([tx, status]) =>
                            `<li class="${getStatusClass(status)}">
                                ${tx}: ${status || 'N/A'}
                            </li>`
                        ).join('')}
                    </ul>
                </div>
            </div>
        `;

        // Alarmes Common
        html += `
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>Alarmes Common (${data.Common ? data.Common.length : 0})</span>
                    <span>‚ñº</span>
                </div>
                <div class="accordion-content">
                    <ul>
                        ${data.Common ? data.Common.map(alarm =>
                            `<li class="${getStatusClass(alarm.statusInterpretado)}">
                                ${alarm.nome}: ${alarm.statusInterpretado || 'Unknown'}
                            </li>`
                        ).join('') : '<li>Nenhum alarme</li>'}
                    </ul>
                </div>
            </div>
        `;

        // Dados por TX (Taxas, PIDs, Cooling, ALC, Alarmes ALC)
        if (data.DadosTXs) {
            Object.entries(data.DadosTXs).forEach(([txKey, txData]) => {
                // S√≥ para TXs processadas ou com dados relevantes
                if (txData && txData.alcStatus !== "N√£o processada" && txData.alcStatus !== "Erro geral no TX") {
                    html += `
                        <div class="accordion">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span>${txKey} - Dados Detalhados</span>
                                <span>‚ñº</span>
                            </div>
                            <div class="accordion-content">
                                <div class="sub-card">
                                    <h5>Taxas de Entrada:</h5>
                                    <ul>
                                        <li>ETH: ${txData.TaxasEntrada?.taxa_ETH || 'N/A'}</li>
                                        <li>ASI: ${txData.TaxasEntrada?.taxa_ASI || 'N/A'}</li>
                                    </ul>
                                </div>
                                <div class="sub-card">
                                    <h5>PIDs:</h5>
                                    <p>TS ID: ${txData.PIDs?.tsId || 'N/A'}</p>
                                    <p>Status: ${txData.PIDs?.status || 'N/A'}</p>
                                    <h6>Programas:</h6>
                                    <ul>
                                        ${txData.PIDs?.programas && txData.PIDs.programas.length > 0 ?
                                            txData.PIDs.programas.map(prog => `<li>${prog.programa} (PIDs: ${prog.pids})</li>`).join('') :
                                            '<li>Nenhum programa encontrado</li>'}
                                    </ul>
                                </div>
                                <div class="sub-card">
                                    <h5>Cooling Status:</h5>
                                    <p class="${getStatusClass(txData.CoolingStatus)}">${txData.CoolingStatus || 'N/A'}</p>
                                </div>
                                <div class="sub-card">
                                    <h5>ALC Status:</h5>
                                    <p class="${getStatusClass(txData.alcStatus)}">${txData.alcStatus || 'N/A'}</p>
                                </div>
                                <div class="sub-card">
                                    <h5>Alarmes ALC:</h5>
                                    <ul>
                                        ${txData.alarmesAlc ? Object.entries(txData.alarmesAlc).map(([alarmName, alarmInfo]) => `
                                            <li class="${getStatusClass(alarmInfo.status)}">
                                                ${alarmName} Status: ${alarmInfo.status || 'N/A'}
                                                ${alarmInfo.value ? ` (Valor: ${alarmInfo.value})` : ''}
                                            </li>
                                        `).join('') : '<li>Nenhum alarme ALC</li>'}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // Alarmes Modulator
        if (data.AlarmesModulator) {
            Object.entries(data.AlarmesModulator).forEach(([txKey, modulatorData]) => {
                if (modulatorData && modulatorData.status !== "TX n√£o habilitada") {
                    html += `
                        <div class="accordion">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span>${txKey} - Alarmes do Modulador</span>
                                <span>‚ñº</span>
                            </div>
                            <div class="accordion-content">
                                <div class="sub-card">
                                    <h5>Video Lock:</h5>
                                    <p class="${getStatusClass(modulatorData['Video Lock'])}">${modulatorData['Video Lock'] || 'N/A'}</p>
                                </div>
                                <div class="sub-card">
                                    <h5>Video White Clipping:</h5>
                                    <p class="${getStatusClass(modulatorData['Video White Clipping'])}">${modulatorData['Video White Clipping'] || 'N/A'}</p>
                                </div>
                                <div class="sub-card">
                                    <h5>Audio Saturation:</h5>
                                    <p class="${getStatusClass(modulatorData['Audio Saturation'])}">${modulatorData['Audio Saturation'] || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // Alarmes por TX (abas TX1 a TX8)
        if (data.TXs) {
            Object.entries(data.TXs).forEach(([txAba, alarmes]) => {
                // S√≥ mostra se houver alarmes ou se a TX foi processada (mesmo que vazia)
                if (alarmes && alarmes.length > 0) {
                    html += `
                        <div class="accordion">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span>${txAba} - Alarmes Espec√≠ficos (${alarmes.length})</span>
                                <span>‚ñº</span>
                            </div>
                            <div class="accordion-content">
                                <ul>
                                    ${alarmes.map(alarm => `
                                        <li class="${getStatusClass(alarm.statusInterpretado)}">
                                            ${alarm.nome}: ${alarm.statusInterpretado || 'Unknown'}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
            });
        }

        content.innerHTML = html;
    }

    // L√≥gica para expandir/colapsar accordions
    function toggleAccordion(header) {
        header.classList.toggle('active');
        const content = header.nextElementSibling;
        if (content.style.display === "block") {
            content.style.display = "none";
            header.querySelector('span:last-child').innerText = '‚ñº';
        } else {
            content.style.display = "block";
            header.querySelector('span:last-child').innerText = '‚ñ≤';
        }
    }

    // NOVA L√ìGICA DE PESQUISA
    const searchInput = document.getElementById('search-input');
    const listaCidadesUl = document.getElementById('lista-cidades');
    const cidadesLi = Array.from(listaCidadesUl.getElementsByTagName('li')); // Converte para Array para facilitar a manipula√ß√£o
    const noResultsMessage = document.getElementById('no-results-message');

    searchInput.addEventListener('keyup', filtrarCidades);

    function filtrarCidades() {
        const searchTerm = searchInput.value.toLowerCase();
        let foundResults = 0;

        cidadesLi.forEach(li => {
            const cityName = li.textContent.toLowerCase();
            if (cityName.includes(searchTerm)) {
                li.classList.remove('hidden');
                foundResults++;
            } else {
                li.classList.add('hidden');
            }
        });

        if (foundResults === 0 && searchTerm.length > 0) {
            noResultsMessage.style.display = 'block';
        } else {
            noResultsMessage.style.display = 'none';
        }
    }

    // Event Listeners para as cidades
    cidadesLi.forEach(li => {
        li.addEventListener('click', () => {
            document.querySelectorAll('#lista-cidades li').forEach(el => el.classList.remove('active'));
            li.classList.add('active');
            const cidadeId = li.getAttribute('data-id');
            const cidadeNome = li.querySelector('span').textContent;

            // Limpa e mostra mensagem de carregamento para a se√ß√£o Nemesys
            document.getElementById('tx-grid').innerHTML = '<p class="loading">Carregando dados do Nemesys...</p>';
            document.getElementById('cidade-info').innerText = `Carregando dados para ${cidadeNome}...`;

            // Limpa e mostra mensagem de carregamento para a se√ß√£o VarreduraGeral
            const varreduraSection = document.getElementById('varredura-section');
            const varreduraContent = document.getElementById('varredura-content');
            varreduraContent.innerHTML = '<p class="loading">Carregando dados do MTX...</p>';
            varreduraSection.style.display = 'block'; // Garante que a se√ß√£o esteja vis√≠vel

            // Fetch para o dashboard Nemesys
            fetch(`/api/dashboard/${cidadeId}`)
                .then(res => res.json())
                .then(data => renderTXs(data))
                .catch(err => {
                    console.error("Erro ao buscar dados do Nemesys:", err);
                    document.getElementById('tx-grid').innerHTML = `<p style="color: #ff002b; text-align: center;">Erro ao carregar dados do Nemesys: ${err.message}</p>`;
                });

            // Fetch para varreduraGeral (MTX) com delay
            setTimeout(() => {
                fetch('/varredurageral?cidade=' + encodeURIComponent(cidadeNome))
                    .then(resp => {
                        if (!resp.ok) throw new Error('Erro na requisi√ß√£o varreduraGeral: ' + resp.status);
                        return resp.json();
                    })
                    .then(data => {
                        console.log("Resultado da varreduraGeral:", data);
                        renderVarredura(data);
                    })
                    .catch(err => {
                        console.error('Erro na varreduraGeral: ' + err.message);
                        document.getElementById('varredura-content').innerHTML = `<p style="color: #ff002b; text-align: center;">Erro ao carregar dados do MTX: ${err.message}</p>`;
                    });
            }, 2000); // Delay de 2 segundos
        });
    });

    function atualizarDataHora() {
        const agora = new Date();
        const dataFormatada = agora.toLocaleDateString('pt-BR');
        const horaFormatada = agora.toLocaleTimeString('pt-BR');
        const dateTimeElem = document.getElementById('dateTime');
        if (dateTimeElem) {
            dateTimeElem.textContent = `${dataFormatada} ${horaFormatada}`;
        }
    }

    setInterval(atualizarDataHora, 1000);
    atualizarDataHora(); // Chama a fun√ß√£o uma vez para exibir a data/hora imediatamente
</script>
</body>
</html>