<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard e Controle de Alarme</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        label, select, button { font-size: 1rem; margin: 5px 0; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; max-height: 300px; overflow: auto; white-space: pre-wrap; }
        div.buttons { margin-bottom: 15px; }
        button { margin-right: 10px; }
    </style>
</head>
<body>
<h1>Dashboard e Controle de Alarme</h1>

<label for="cidadeSelect">Selecione a cidade:</label>
<select id="cidadeSelect">
    <option value="29">Cidade 29</option>
    <option value="108">Cidade 108</option>
    <option value="123">Cidade 123</option>
    <option value="456">Cidade 456</option>
</select>

<div class="buttons">
    <button id="btnLogin">Consultar Dashboard</button>
    <button id="btnDesligar">Desligar Alarme PSU1</button>
    <button id="btnAlarmes">Alarmes Ativos</button>
    <button id="btnFaultsSetup">Alarmes Fault do Setup</button>
    <button id="btnFuncaoRemux">Função Remux</button>
    <button id="btnFuncaoTaxa">Verificar Valor das Taxas de Entrada</button>
    <button id="btnFuncaoPids">Buscar PIDs dos Programas</button>
    <button id="btnAlcStatus">Verificar Statud do ALC</button>
</div>

<h2>Resultado:</h2>
<pre id="resultado">Escolha uma das opções acima.</pre>

<script>
    const cidadeSelect = document.getElementById('cidadeSelect');
    const btnLogin = document.getElementById('btnLogin');
    const btnDesligar = document.getElementById('btnDesligar');
    const btnAlarmes = document.getElementById('btnAlarmes');
    const btnFaultsSetup = document.getElementById('btnFaultsSetup');
    const btnFuncaoRemux = document.getElementById('btnFuncaoRemux');
    const btnFuncaoTaxa = document.getElementById('btnFuncaoTaxa');
    const btnFuncaoPids = document.getElementById('btnFuncaoPids');
    const resultado = document.getElementById('resultado');

    function chamarLogin() {
        const cidade = cidadeSelect.value;
        resultado.textContent = 'Aguarde, processando...';

        fetch('/login?cidade=' + encodeURIComponent(cidade))
            .then(resp => {
                if (!resp.ok) throw new Error('Erro na requisição: ' + resp.status);
                return resp.json();
            })
            .then(data => {
                resultado.textContent = JSON.stringify(data, null, 2);
            })
            .catch(err => {
                resultado.textContent = 'Erro: ' + err.message;
            });
    }

    btnLogin.addEventListener('click', () => {
        resultado.textContent = 'Consultando dashboard para cidade ' + cidadeSelect.value + '...';
        chamarLogin();
    });

    btnDesligar.addEventListener('click', () => {
        const cidade = cidadeSelect.value;
        resultado.textContent = 'Enviando comando para desligar alarme PSU1 na cidade ' + cidade + '...';

        fetch('/desligarAlarme?cidade=' + encodeURIComponent(cidade))
            .then(resp => {
                if (!resp.ok) throw new Error('Erro na requisição: ' + resp.status);
                return resp.json();
            })
            .then(data => {
                resultado.textContent = JSON.stringify(data, null, 2);
            })
        .catch(err => {
            resultado.textContent = 'Erro: ' + err.message;
        });
    });

    btnAlarmes.addEventListener('click', () => {
        const cidade = cidadeSelect.value;
        resultado.textContent = 'Buscando alarmes ativos...';

        fetch('/alarmess?cidade=' + encodeURIComponent(cidade))
            .then(resp => {
                if (!resp.ok) throw new Error('Erro na requisição: ' + resp.status);
                return resp.json();
            })
            .then(data => {
                if (data.status === "Sucesso") {
                    if (!data.alarmess || data.alarmess.length === 0) {
                        resultado.textContent = "Nenhum alarme ativo encontrado.";
                    } else {
                        let texto = "Alarmes ativos:\n\n";
                        data.alarmess.forEach((alarme, i) => {
                            texto += `${i+1}. [${alarme.tipo}] ${alarme.mensagem}\n    Data: ${alarme.data}\n    Status: ${alarme.status}\n\n`;
                        });
                        resultado.textContent = texto;
                    }
                } else {
                    resultado.textContent = "Erro: " + (data.erro || "Resposta inesperada");
                }
            })
            .catch(err => {
                resultado.textContent = 'Erro: ' + err.message;
            });
    });

    btnFaultsSetup.addEventListener('click', () => {
        const cidade = cidadeSelect.value;
        resultado.textContent = 'Buscando alarme Fault específico do setup...';

        fetch('/alarmessSetupFaults?cidade=' + encodeURIComponent(cidade))
            .then(resp => {
                if (!resp.ok) throw new Error('Erro na requisição: ' + resp.status);
                return resp.json();
            })
            .then(data => {
                if (data.status === "Sucesso") {
                    if (!data.fault || Object.keys(data.fault).length === 0) {
                        resultado.textContent = "Nenhum alarme Fault ativo no setup.";
                    } else {
                        let fault = data.fault;
                        let texto = "Alarme Fault específico no setup:\n\n";
                        texto += `[${fault.categoria}] ${fault.mensagem}\nTipo Log: ${fault.tipoLog}\nStatus Led: ${fault.statusLed}\n`;
                        resultado.textContent = texto;
                    }
                } else {
                    resultado.textContent = "Erro: " + (data.erro || "Resposta inesperada");
                }
            })
            .catch(err => {
                resultado.textContent = 'Erro: ' + err.message;
            });
    });

    btnFuncaoRemux.addEventListener('click', () => {
        const cidade = cidadeSelect.value;
        resultado.textContent = 'Executando função Remux para cidade ' + cidade + '...';

        fetch('/funcaoRemux?cidade=' + encodeURIComponent(cidade))
            .then(resp => {
                if (!resp.ok) throw new Error('Erro na requisição: ' + resp.status);
                return resp.json();
            })
            .then(data => {
                resultado.textContent = JSON.stringify(data, null, 2);
            })
            .catch(err => {
                resultado.textContent = 'Erro: ' + err.message;
            });
    });

    btnFuncaoTaxa.addEventListener('click', () => {
        const cidade = cidadeSelect.value;
        resultado.textContent = 'Buscando taxas de entrada para cidade ' + cidade + '...';

        fetch('/funcaoTaxa?cidade=' + encodeURIComponent(cidade))
            .then(resp => {
                if (!resp.ok) throw new Error('Erro na requisição: ' + resp.status);
                return resp.json();
            })
            .then(data => {
                resultado.textContent = JSON.stringify(data, null, 2);
            })
            .catch(err => {
                resultado.textContent = 'Erro: ' + err.message;
            });
    });

    btnFuncaoPids.addEventListener('click', () => {
        const cidade = cidadeSelect.value;
        resultado.textContent = 'Buscando PIDs dos programas para cidade ' + cidade + '...';

        fetch('/funcaoPids?cidade=' + encodeURIComponent(cidade))
            .then(resp => {
                if (!resp.ok) throw new Error('Erro na requisição: ' + resp.status);
                return resp.json();
            })
            .then(data => {
                if (data.status === "Sequência executada com sucesso") {
                    let texto = `TS ID: ${data.tsId}\n\nProgramas encontrados:\n\n`;
                    if (data.programas && data.programas.length > 0) {
                        data.programas.forEach((prog, i) => {
                            texto += `${i+1}. ${prog.programa}\n    PIDs: ${prog.pids}\n\n`;
                        });
                    } else {
                        texto += "Nenhum programa encontrado.\n";
                    }
                    resultado.textContent = texto;
                } else {
                    resultado.textContent = JSON.stringify(data, null, 2);
                }
            })
            .catch(err => {
                resultado.textContent = 'Erro: ' + err.message;
            });
    });
</script>
</body>
</html>
